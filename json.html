<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JSON Visual Diff Tool</title>
    <style>
        body { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; background: #f6f8fa; margin: 0; padding: 20px; }
        .setup-area { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 20px; align-items: center; justify-content: center; }
        .file-input { border: 1px dashed #aaa; padding: 10px; border-radius: 4px; }
        button { padding: 10px 30px; background: #2ea44f; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2c974b; }

        .file-container { background: white; border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 30px; overflow: hidden; }
        .file-header { padding: 10px 15px; background: #f6f8fa; border-bottom: 1px solid #d0d7de; font-weight: bold; display: flex; justify-content: space-between; }
        
        .diff-table { width: 100%; border-collapse: collapse; font-size: 12px; line-height: 1.5; }
        .diff-row { display: flex; width: 100%; }
        .line-num { width: 40px; text-align: right; padding-right: 10px; color: #afb8c1; user-select: none; background: #f6f8fa; border-right: 1px solid #d0d7de; }
        .line-content { flex: 1; padding-left: 10px; white-space: pre-wrap; word-break: break-all; }
        
        /* 差分カラー */
        .added { background-color: #dafbe1; color: #1a7f37; }
        .added .line-content::before { content: "+ "; }
        .removed { background-color: #ffebe9; color: #cf222e; }
        .removed .line-content::before { content: "- "; }
        .unchanged { color: #24292f; }
        .unchanged .line-content::before { content: "  "; }
        
        .status-tag { padding: 2px 8px; border-radius: 12px; font-size: 11px; }
        .tag-diff { background: #fff8c5; color: #9a6700; border: 1px solid #d4a72c; }
        .tag-match { background: #dafbe1; color: #1a7f37; border: 1px solid #4ac26b; }
        .tag-missing { background: #ffebe9; color: #cf222e; border: 1px solid #ff8182; }
    </style>
</head>
<body>

<div class="setup-area">
    <div class="file-input">フォルダA: <input type="file" id="folderA" webkitdirectory></div>
    <div class="file-input">フォルダB: <input type="file" id="folderB" webkitdirectory></div>
    <button onclick="runDiff()">比較実行</button>
</div>

<div id="output"></div>

<script>
async function getJsonString(file) {
    try {
        const obj = JSON.parse(await file.text());
        // キーをソートして整形することで、プロパティの順番の違いによる誤検知を防ぐ
        return JSON.stringify(obj, Object.keys(obj).sort(), 2).split('\n');
    } catch (e) {
        return ["JSONの解析に失敗しました"];
    }
}

async function runDiff() {
    const inputA = document.getElementById('folderA').files;
    const inputB = document.getElementById('folderB').files;
    const output = document.getElementById('output');
    output.innerHTML = "読み込み中...";

    const mapA = new Map(), mapB = new Map();
    for (let f of inputA) if (f.name.endsWith('.json')) mapA.set(f.webkitRelativePath.split('/').slice(1).join('/'), f);
    for (let f of inputB) if (f.name.endsWith('.json')) mapB.set(f.webkitRelativePath.split('/').slice(1).join('/'), f);

    const allPaths = Array.from(new Set([...mapA.keys(), ...mapB.keys()])).sort();
    let finalHtml = "";

    for (let path of allPaths) {
        const fileA = mapA.get(path);
        const fileB = mapB.get(path);

        if (!fileA || !fileB) {
            finalHtml += createHeader(path, "欠落", "tag-missing");
            continue;
        }

        const linesA = await getJsonString(fileA);
        const linesB = await getJsonString(fileB);

        // 簡易的な差分計算ロジック
        const diffData = computeDiff(linesA, linesB);
        
        const hasDiff = diffData.some(d => d.type !== 'unchanged');
        const statusText = hasDiff ? "相違あり" : "一致";
        const statusClass = hasDiff ? "tag-diff" : "tag-match";

        let fileHtml = createHeader(path, statusText, statusClass);
        
        if (hasDiff) {
            fileHtml += `<div class="diff-table">`;
            diffData.forEach((line, idx) => {
                fileHtml += `
                    <div class="diff-row ${line.type}">
                        <div class="line-num">${idx + 1}</div>
                        <div class="line-content">${escapeHtml(line.text)}</div>
                    </div>`;
            });
            fileHtml += `</div>`;
        }
        finalHtml += `<div class="file-container">${fileHtml}</div>`;
    }
    output.innerHTML = finalHtml || "JSONファイルが見つかりませんでした。";
}

function createHeader(path, status, className) {
    return `<div class="file-header"><span>${path}</span><span class="status-tag ${className}">${status}</span></div>`;
}

function escapeHtml(str) {
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// 行単位の差分ロジック (簡易実装)
function computeDiff(oldLines, newLines) {
    let result = [];
    let i = 0, j = 0;

    while (i < oldLines.length || j < newLines.length) {
        if (i < oldLines.length && j < newLines.length && oldLines[i] === newLines[j]) {
            result.push({ type: 'unchanged', text: oldLines[i] });
            i++; j++;
        } else {
            // 変更がある場合：一旦削除して追加する形式で表示
            if (i < oldLines.length) {
                result.push({ type: 'removed', text: oldLines[i] });
                i++;
            }
            if (j < newLines.length) {
                result.push({ type: 'added', text: newLines[j] });
                j++;
            }
        }
    }
    return result;
}
</script>
</body>
</html>
